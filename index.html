<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <title>Unemployment Bubble Chart</title>
  <link rel="stylesheet" type="text/css" href="css/main.css">
</head>
<body>
  <div id="container" class="svg-container"></div>
  <script src='//d3js.org/d3.v4.min.js'></script>
  <script src="//d3js.org/topojson.v1.min.js"></script>
  <script src='//cdn.rawgit.com/Caged/d3-tip/v0.8.0-alpha.1/index.js'></script>

  <script>
     var tip = d3.tip()
      .attr('class', 'd3-tip')
      .offset([0, 0])
      .html(function(d) {
        return '<div>' + d.properties.STATE + '</div>' +
          '<div>' + getNumberOfClaimsForState(d.properties.STATE) + '</div>' +
          '<div>unemployed</div>';
      });

    var getColorForNumberOfClaims = function(stateName) {
      var stateClaims = getNumberOfClaimsForState(stateName); 
      if (!stateClaims) {
        return '#ccc';
      } else {
        return _claimsColorScale(stateClaims);
      }
    };

    var getNumberOfClaimsForState = function(stateName) {
      return _stateClaims[stateName]; 
    };

    var _claimsColorScale;

    var _states, _claims, _stateClaims = {}, _locations;

    var drawMapCircles = function(layoffs) {
      var circleGroup = svg.selectAll('circle')
        .data(_locations.records)
        .enter()
        .append('g')
        .attr('transform', function(d) {
          return 'translate('+ projection([d.fields.lon, d.fields.lat])+')';
                    })
        .attr('class', 'city');

      circleGroup
        .append('circle')
        .style('fill', 'red')
        .style("stroke", "grey")
        .style('fill-opacity', .8)
        .attr('r', 5)
    };

    var layoffsDataReady = function(error, layoffs) {
      if (error) throw error;

      drawMapCircles(layoffs);
    }

    var dataReady = function(error, states, claims, locations) {
      if (error) throw error;
      _states = states;
      _claims = claims;
      _locations = locations;
      var claimsNumbers = claims.records.flatMap(function(claim) { return claim.fields.claims; });
      var minClaims = Math.min(...claimsNumbers);
      var maxClaims = Math.max(...claimsNumbers);

      _claimsColorScale = d3.scaleQuantize()
        .domain([minClaims, maxClaims])
        .range(['#3B3137', '#4D383E', '#604045', '#523134', '#95565B', '#A95E63', '#BB666A' , '#CE6E71' , '#E07769']);


      // build up the state claim numbers map for easy retrieval later
      _claims.records.forEach(function(claim) {
        _stateClaims[claim.fields.state] = claim.fields.claims;
      });

      renderMap(_states, _claims);

      var layoffRecordIds = (locations.records.flatMap(function(r) {
        return 'RECORD_ID()=\'' + r.fields.layoffs + '\'';
      })).join(','); 

      var layoffsRequest = d3.json('https://api.airtable.com/v0/appQWZIOAEl6UiPa3/people?view=map_view&&filterByFormula=OR("' + layoffRecordIds + '")')
        .header('Authorization', 'Bearer keyLVEYQelX6aEgaR');

      d3.queue()
        .defer(layoffsRequest.get)
        .await(layoffsDataReady)
    }

    var renderMap = function(states, claims) {
      svg.selectAll('*').remove(); // clear for re-render
      
      svg.selectAll('.states')
        .data(topojson.feature(states, states.objects.states).features)
        .enter()
        .append('path')
        .attr('class', 'state')
        .style('fill', function (st) { 
          return getColorForNumberOfClaims(st.properties.STATE) 
        })
        .attr('d', path)
        .on('mouseover', tip.show)
        .on('mouseout', tip.hide);
    }

    var svg = d3.select('#container').append('svg')
      .attr('xmlns', 'http://www.w3.org/2000/svg')
      .attr('version', '1.1')
      .attr('viewBox', '0 0 900 500')
      .attr('preserveAspectRatio', 'xMidYMid meet')
      .classed('svg-content', true);

    svg.call(tip);
    var projection = d3.geoAlbersUsa();
    var path = d3.geoPath().projection(projection);

    var claimsRequest = d3.json('https://api.airtable.com/v0/appQWZIOAEl6UiPa3/ui_claims?view=Grid%20view')
      .header('Authorization', 'Bearer keyLVEYQelX6aEgaR');

    var locationsRequest = d3.json('https://api.airtable.com/v0/appQWZIOAEl6UiPa3/locations?view=map_view&filterByFormula=NOT({lat}="")')
      .header('Authorization', 'Bearer keyLVEYQelX6aEgaR');

    d3.queue()
      .defer(d3.json, 'data/us-states-simplified.json')
      .defer(claimsRequest.get)
      .defer(locationsRequest.get)
      .await(dataReady);

  </script>
</body>
</html>
