<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <title>Unemployment Bubble Chart</title>
  <link rel="stylesheet" type="text/css" href="css/main.css">
</head>
<body>
  <div id="container" class="svg-container"></div>
  <script src='//d3js.org/d3.v4.min.js'></script>
  <script src="//d3js.org/topojson.v1.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

  <script>

    var getNumberOfClaimsForState = function(st) {
      var stateClaims = _stateClaims[st.properties.STATE]; 
      if (!stateClaims) {
        return '#ccc';
      } else {
        return claimsColorScale(stateClaims);
      }
    };

    var claimsColorScale = d3.scaleQuantize()
      .domain(['4e+3', '1e+6'])
      .range(['#3B3137', '#4D383E', '#604045', '#523134', '#95565B', '#A95E63', '#BB666A' , '#CE6E71' , '#E07769']);

    var _states, _claims, _stateClaims = {};

    var dataReady = function(error, states, claims) {
      if (error) throw error;
      _states = states;
      _claims = claims;

      // build up the state claim numbers map for easy retrieval later
      _claims.records.forEach(function(claim) {
        _stateClaims[claim.fields.state] = claim.fields.claims;
      });

      renderMap(_states, _claims);
    }

    var renderMap = function(states, claims) {
      svg.selectAll('*').remove(); // clear for re-render
      
      svg.selectAll('.states')
        .data(topojson.feature(states, states.objects.states).features)
        .enter()
        .append('path')
        .attr('class', 'state')
        .style('fill', function (st) { 
          return getNumberOfClaimsForState(st) 
        })
        .attr('d', path);
    }

    var svg = d3.select('#container').append('svg')
      .attr('xmlns', 'http://www.w3.org/2000/svg')
      .attr('version', '1.1')
      .attr('viewBox', '0 0 900 500')
      .attr('preserveAspectRatio', 'xMidYMid meet')
      .classed('svg-content', true);

    var projection = d3.geoAlbersUsa();
    var path = d3.geoPath().projection(projection);

    var claimsRequest = d3.json('https://api.airtable.com/v0/appQWZIOAEl6UiPa3/ui_claims?view=Grid%20view')
      .header('Authorization', 'Bearer keyLVEYQelX6aEgaR');

    d3.queue()
      .defer(d3.json, 'data/us-states-simplified.json')
      .defer(claimsRequest.get)
      .await(dataReady);

  </script>
</body>
</html>
